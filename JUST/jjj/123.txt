from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.options import Options
from selenium.common.exceptions import TimeoutException, NoSuchElementException
import time
import os
import re

class JBNUSeleniumDownloader:
    def __init__(self, download_path="./downloads/ì „ë¶ëŒ€_ì·¨ì—…ì„±ê³µìˆ˜ê¸°", headless=False):
        self.download_path = os.path.abspath(download_path)
        
        # Chrome ì˜µì…˜ ì„¤ì •
        chrome_options = Options()
        if headless:
            chrome_options.add_argument("--headless")
        chrome_options.add_argument("--no-sandbox")
        chrome_options.add_argument("--disable-dev-shm-usage")
        chrome_options.add_argument("--disable-blink-features=AutomationControlled")
        
        # ë‹¤ìš´ë¡œë“œ ì„¤ì •
        prefs = {
            "download.default_directory": self.download_path,
            "download.prompt_for_download": False,
            "download.directory_upgrade": True,
            "safebrowsing.enabled": True
        }
        chrome_options.add_experimental_option("prefs", prefs)
        chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
        chrome_options.add_experimental_option('useAutomationExtension', False)
        
        self.driver = webdriver.Chrome(options=chrome_options)
        self.driver.execute_script("Object.defineProperty(navigator, 'webdriver', {get: () => undefined})")
        self.wait = WebDriverWait(self.driver, 15)
        
        # ë‹¤ìš´ë¡œë“œ í´ë” ìƒì„±
        if not os.path.exists(self.download_path):
            os.makedirs(self.download_path)
    
    def login(self, username, password):
        """ë¡œê·¸ì¸"""
        try:
            print("ğŸ” ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘...")
            self.driver.get("https://career.jbnu.ac.kr/career/login.do")
            
            # ì•„ì´ë”” ì…ë ¥
            user_id_input = self.wait.until(
                EC.presence_of_element_located((By.NAME, "userId"))
            )
            user_id_input.clear()
            user_id_input.send_keys(username)
            
            # ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
            password_input = self.driver.find_element(By.NAME, "userPw")
            password_input.clear()
            password_input.send_keys(password)
            
            # ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
            login_button = self.driver.find_element(By.XPATH, 
                "//input[@type='submit' or @type='button'][contains(@value, 'ë¡œê·¸ì¸') or contains(@value, 'LOGIN')]"
            )
            login_button.click()
            
            # ë¡œê·¸ì¸ ì„±ê³µ í™•ì¸
            time.sleep(3)
            if "ë¡œê·¸ì•„ì›ƒ" in self.driver.page_source or "logout" in self.driver.page_source.lower():
                print("âœ… ë¡œê·¸ì¸ ì„±ê³µ!")
                return True
            else:
                print("âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨")
                return False
                
        except Exception as e:
            print(f"âŒ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜: {e}")
            return False
    
    def get_total_pages(self):
        """ì „ì²´ í˜ì´ì§€ ìˆ˜ í™•ì¸"""
        try:
            self.driver.get("https://career.jbnu.ac.kr/career/21903/subview.do")
            time.sleep(2)
            
            # í˜ì´ì§• ì˜ì—­ì—ì„œ ë§ˆì§€ë§‰ í˜ì´ì§€ ë²ˆí˜¸ ì°¾ê¸°
            page_selectors = [
                ".paging a",
                ".pagination a", 
                ".page-nav a",
                "a[href*='page=']"
            ]
            
            max_page = 1
            for selector in page_selectors:
                try:
                    page_links = self.driver.find_elements(By.CSS_SELECTOR, selector)
                    for link in page_links:
                        text = link.text.strip()
                        if text.isdigit():
                            max_page = max(max_page, int(text))
                        
                        href = link.get_attribute('href')
                        if href and 'page=' in href:
                            page_match = re.search(r'page=(\d+)', href)
                            if page_match:
                                max_page = max(max_page, int(page_match.group(1)))
                except:
                    continue
            
            print(f"ğŸ“„ ê°ì§€ëœ ì´ í˜ì´ì§€ ìˆ˜: {max_page}")
            return max_page
            
        except Exception as e:
            print(f"âš ï¸ í˜ì´ì§€ ìˆ˜ í™•ì¸ ì¤‘ ì˜¤ë¥˜: {e}")
            return 10
    
    def download_page_files(self, page_num):
        """íŠ¹ì • í˜ì´ì§€ì˜ ëª¨ë“  íŒŒì¼ ë‹¤ìš´ë¡œë“œ"""
        try:
            # í˜ì´ì§€ë¡œ ì´ë™
            url = f"https://career.jbnu.ac.kr/career/21903/subview.do?page={page_num}"
            self.driver.get(url)
            time.sleep(2)
            
            # ê²Œì‹œê¸€ ë§í¬ë“¤ ì°¾ê¸°
            post_selectors = [
                "a[href*='subview']",
                "tbody tr a",
                ".board-list a"
            ]
            
            post_links = []
            for selector in post_selectors:
                try:
                    links = self.driver.find_elements(By.CSS_SELECTOR, selector)
                    post_links.extend([link.get_attribute('href') for link in links 
                                     if link.get_attribute('href') and 'subview' in link.get_attribute('href')])
                    if post_links:
                        break
                except:
                    continue
            
            # ì¤‘ë³µ ì œê±°
            post_links = list(set(post_links))
            print(f"  ğŸ“ {len(post_links)}ê°œì˜ ê²Œì‹œê¸€ ë°œê²¬")
            
            downloads_count = 0
            
            for i, post_url in enumerate(post_links, 1):
                try:
                    print(f"    [{i:2d}/{len(post_links)}] ê²Œì‹œê¸€ í™•ì¸ ì¤‘...")
                    
                    # ê²Œì‹œê¸€ë¡œ ì´ë™
                    self.driver.get(post_url)
                    time.sleep(1)
                    
                    # ì œëª© ê°€ì ¸ì˜¤ê¸°
                    try:
                        title_element = self.driver.find_element(By.CSS_SELECTOR, 
                            "h1, h2, h3, .title, .subject, .post-title")
                        title = title_element.text.strip()[:30]
                    except:
                        title = f"ê²Œì‹œê¸€_{i}"
                    
                    print(f"      ğŸ“„ {title}...")
                    
                    # ì²¨ë¶€íŒŒì¼ ë§í¬ ì°¾ê¸°
                    download_selectors = [
                        "a[href*='download']",
                        "a[onclick*='download']",
                        "a[href*='file']",
                        ".attach a",
                        ".file-list a",
                        ".attachment a"
                    ]
                    
                    download_links = []
                    for selector in download_selectors:
                        try:
                            links = self.driver.find_elements(By.CSS_SELECTOR, selector)
                            download_links.extend(links)
                        except:
                            continue
                    
                    if download_links:
                        print(f"      ğŸ“ {len(download_links)}ê°œì˜ ì²¨ë¶€íŒŒì¼ ë°œê²¬")
                        
                        for j, link in enumerate(download_links, 1):
                            try:
                                file_name = link.text.strip() or f"attachment_{j}"
                                print(f"        [{j}] {file_name} ë‹¤ìš´ë¡œë“œ ì¤‘...")
                                
                                # ë‹¤ìš´ë¡œë“œ í´ë¦­
                                self.driver.execute_script("arguments[0].click();", link)
                                time.sleep(2)  # ë‹¤ìš´ë¡œë“œ ëŒ€ê¸°
                                downloads_count += 1
                                print(f"        âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ")
                                
                            except Exception as e:
                                print(f"        âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: {e}")
                    else:
                        print(f"      ğŸ“ ì²¨ë¶€íŒŒì¼ ì—†ìŒ")
                        
                except Exception as e:
                    print(f"    âŒ ê²Œì‹œê¸€ ì²˜ë¦¬ ì‹¤íŒ¨: {e}")
                    continue
            
            return downloads_count
            
        except Exception as e:
            print(f"âš ï¸ í˜ì´ì§€ {page_num} ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")
            return 0
    
    def download_all_pages(self, max_pages=None):
        """ëª¨ë“  í˜ì´ì§€ì˜ íŒŒì¼ ë‹¤ìš´ë¡œë“œ"""
        print("ğŸ” ì „ì²´ í˜ì´ì§€ ìˆ˜ í™•ì¸ ì¤‘...")
        
        if max_pages is None:
            total_pages = self.get_total_pages()
        else:
            total_pages = max_pages
        
        print(f"ğŸ“š ì´ {total_pages}í˜ì´ì§€ ì²˜ë¦¬ ì˜ˆì •\n")
        
        total_downloads = 0
        
        for page in range(1, total_pages + 1):
            print(f"ğŸ“– === {page}/{total_pages} í˜ì´ì§€ ì²˜ë¦¬ ì¤‘ ===")
            
            try:
                page_downloads = self.download_page_files(page)
                total_downloads += page_downloads
                print(f"  âœ… {page}í˜ì´ì§€ ì™„ë£Œ ({page_downloads}ê°œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ)\n")
                
            except Exception as e:
                print(f"  âŒ {page}í˜ì´ì§€ ì²˜ë¦¬ ì‹¤íŒ¨: {e}\n")
                continue
            
            time.sleep(1)  # í˜ì´ì§€ ê°„ ì§€ì—°
        
        print(f"ğŸ‰ === ì „ì²´ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ ===")
        print(f"ğŸ“Š ì´ {total_downloads}ê°œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ")
        print(f"ğŸ“ ì €ì¥ ê²½ë¡œ: {self.download_path}")
        
        return total_downloads
    
    def close(self):
        """ë¸Œë¼ìš°ì € ì¢…ë£Œ"""
        self.driver.quit()

# Selenium ì‚¬ìš© ì˜ˆì œ
def selenium_main():
    print("=== ì „ë¶ëŒ€í•™êµ ì·¨ì—…ì„±ê³µìˆ˜ê¸° ë‹¤ìš´ë¡œë” (Selenium) ===\n")
    
    username = input("ì „ë¶ëŒ€ í¬í„¸ ì•„ì´ë””: ")
    password = input("ë¹„ë°€ë²ˆí˜¸: ")
    
    max_pages_input = input("ë‹¤ìš´ë¡œë“œí•  ìµœëŒ€ í˜ì´ì§€ ìˆ˜ (ì—”í„°: ì „ì²´): ").strip()
    max_pages = int(max_pages_input) if max_pages_input.isdigit() else None
    
    headless_input = input("ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰? (y/N): ").strip().lower()
    headless = headless_input == 'y'
    
    downloader = JBNUSeleniumDownloader(headless=headless)
    
    try:
        if downloader.login(username, password):
            downloader.download_all_pages(max_pages)
        else:
            print("âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨")
            
    finally:
        downloader.close()

if __name__ == "__main__":
    # ì‚¬ìš© ë°©ë²• ì„ íƒ
    print("ë‹¤ìš´ë¡œë“œ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”:")
    print("1. requests + BeautifulSoup (ë¹ ë¦„)")
    print("2. Selenium (ì•ˆì •ì )")
    
    choice = input("ì„ íƒ (1 ë˜ëŠ” 2): ").strip()
    
    if choice == "2":
        selenium_main()
    else:
        main()
